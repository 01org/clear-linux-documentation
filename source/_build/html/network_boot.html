<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Network booting &#8212; Documentation for Clear Linux* Project for Intel(r) Architecture</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Documentation for Clear Linux* Project for Intel(r) Architecture" href="index.html" />
    <link rel="up" title="Advanced configuration" href="index_advanced_configuration.html" />
    <link rel="next" title="Bulk Provisioning" href="bulk_provisioning.html" />
    <link rel="prev" title="Intel® Clear Containers" href="clear-containers.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="network-booting">
<span id="network-boot"></span><h1>Network booting</h1>
<p>Network booting is an important feature that every data center should have;
it can be used, among other things, to install an operating system. To do this,
a <abbr title="PXE">Pre-boot eXecution Environment</abbr> is defined upon a foundation of
industry-standard Internet protocols and services, namely TCP/IP, DHCP, and
<a class="reference external" href="http://download.intel.com/design/archives/wfm/downloads/pxespec.pdf">TFTP</a>.</p>
<p>Clear Linux* Project for Intel® Architecture uses UEFI to boot, so your target
machine should be UEFI-capable. At present, the UEFI binary is not signed, so
be sure to disable secure boot.</p>
<div class="section" id="network-setup-options">
<h2>Network Setup Options</h2>
<p>There are two basic network configurations:</p>
<ul class="simple">
<li>Place all of your nodes behind a <abbr title="NAT">Network Address Traversal</abbr>, or</li>
<li>Connect one node to your regular network and the other to a switch
connecting all your machines. This option requires at least two network
interfaces (dual NIC).</li>
</ul>
<p>Note that lack of (or incorrectly-configured) NAT can expose your cluster to external
networks. NAT allows you to control the traffic that goes to the external network.</p>
<p>A script for NAT setup can be found on this <a class="reference external" href="https://gist.github.com/pdxjohnny/d6945910bf7bed962438bf64e70a6a40">gist</a>. Be sure
to export the DOMAIN and DNS variables to be the domain name of your internal
network (example.com) and whatever DNS servers you want to use (8.8.8.8 and
8.8.4.4 DNS can work for some situations).</p>
</div>
<div class="section" id="network-topologies">
<h2>Network Topologies</h2>
<div class="section" id="dual-nic">
<h3>Dual NIC</h3>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+----------+</span>
<span class="go">| External |</span>
<span class="go">| Network  |</span>
<span class="go">+----------+-----------+----------------+----------------+</span>
<span class="go">     |                 |                |                |</span>
<span class="go">     |                 |                |                |</span>
<span class="go">+----------+      +----------+     +----------+     +----------+</span>
<span class="go">| Network  |      | PXE      |     | PXE      |     | PXE      |</span>
<span class="go">| Boot     |      | Boot     |     | Boot     |     | Boot     |</span>
<span class="go">| Server   |      | Client   |     | Client   |     | Client   |</span>
<span class="go">+----------+      +----------+     +----------+     +----------+</span>
<span class="go">     |                 |                |                |</span>
<span class="go">     |                 |                |                |</span>
<span class="go">+----------+-----------+----------------+----------------+</span>
<span class="go">| Internal |</span>
<span class="go">| Network  |</span>
<span class="go">+----------+</span>
</pre></div>
</div>
</div>
<div class="section" id="nat">
<h3>NAT</h3>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+----------+</span>
<span class="go">| External |</span>
<span class="go">| Network  |</span>
<span class="go">+----------+</span>
<span class="go">     |</span>
<span class="go">     |</span>
<span class="go">+----------+      +----------+     +----------+     +----------+</span>
<span class="go">| Network  |      | PXE      |     | PXE      |     | PXE      |</span>
<span class="go">| Boot     |      | Boot     |     | Boot     |     | Boot     |</span>
<span class="go">| Server   |      | Client   |     | Client   |     | Client   |</span>
<span class="go">+----------+      +----------+     +----------+     +----------+</span>
<span class="go">     |                 |                |                |</span>
<span class="go">     |                 |                |                |</span>
<span class="go">+----------+-----------+----------------+----------------+</span>
<span class="go">| Internal |</span>
<span class="go">| Network  |</span>
<span class="go">+----------+</span>
</pre></div>
</div>
<p>Dual-NIC setup information will be added in the future. This guide currently
only covers NAT setup.</p>
</div>
</div>
<div class="section" id="pxe-ipxe">
<h2>PXE + iPXE</h2>
<p>To retrieve data through other protocols such as HTTP, iSCSI, <abbr title="AoE">ATA over Ethernet</abbr>, or <abbr title="FCoE">Fiber Channel over Ethernet</abbr>, an open source network boot
firmware called <strong>iPXE</strong> was created. iPXE provides a full PXE implementation,
enhanced with additional features. It can be used to enable network booting from
computers that lack built-in PXE support.</p>
<p>Clear Linux* Project for Intel Architecture can be configured to do network
booting via HTTP, with the help of iPXE. The following sets up an iPXE
environment using Clear Linux OS for Intel Architecture; these configuration
options can also be applied elsewhere.</p>
<div class="section" id="step-1">
<h3>Step 1</h3>
<p>Add the <code class="docutils literal"><span class="pre">pxe-server</span></code> bundle to your system; this has all the bits to run a PXE
server.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> swupd bundle-add pxe-server
</pre></div>
</div>
</div>
<div class="section" id="step-2">
<h3>Step 2</h3>
<p>Configure the <code class="docutils literal"><span class="pre">tftpd</span></code> service using <code class="docutils literal"><span class="pre">dnsmasq</span></code>. To do this, populate the
<code class="file docutils literal"><span class="pre">/etc/dnsmasq.conf</span></code> file with the following entries:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &lt;&lt; EOF &gt; /etc/dnsmasq.conf
<span class="go">enable-tftp</span>
<span class="go">tftp-root=/srv/tftp/</span>
<span class="go">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3">
<h3>Step 3</h3>
<p>Copy the <code class="file docutils literal"><span class="pre">/usr/share/ipxe/undionly.kpxe</span></code> (legacy) and
<code class="file docutils literal"><span class="pre">/usr/share/ipxe/ipxe-x86_64.efi</span></code> files, and place them in your TFTP
directory.</p>
<p>You can also download the <code class="docutils literal"><span class="pre">undionly.kpxe</span></code> (legacy) and <code class="docutils literal"><span class="pre">ipxe.efi</span></code> (EFI)
files from the <a class="reference external" href="http://boot.ipxe.org/">iPXE website</a>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir /srv/tftp/
<span class="gp">#</span> cp /usr/share/ipxe/undionly.kpxe /srv/tftp/undionly.kpxe
<span class="gp">#</span> cp /usr/share/ipxe/ipxe-x86_64.efi /srv/tftp/ipxe.efi
</pre></div>
</div>
<p><strong>Note</strong>: If booting with a 32-bit UEFI, copy the
<code class="file docutils literal"><span class="pre">/usr/share/ipxe/ipxe-i386.efi</span></code> file instead.</p>
</div>
<div class="section" id="step-4">
<h3>Step 4</h3>
<p>Start the dnsmasq service with:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl start dnsmasq.service
</pre></div>
</div>
</div>
<div class="section" id="step-5">
<h3>Step 5</h3>
<p>The kernel (linux), initramfs (initrd) and the iPXE scripts are transported via
HTTP. Download the Linux kernel and initrd files, and put them in the http
server root <code class="docutils literal"><span class="pre">/var/www/pxe/</span></code>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir -p /var/www/pxe/
<span class="gp">#</span> <span class="nv">version</span><span class="o">=</span><span class="k">$(</span>curl https://download.clearlinux.org/latest<span class="k">)</span>
<span class="gp">#</span> curl -o /var/www/pxe/clear-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>-pxe.tar.xz https://download.clearlinux.org/current/clear-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>-pxe.tar.xz
<span class="gp">#</span> tar -xJf /var/www/pxe/clear-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>-pxe.tar.xz -C /var/www/pxe/ <span class="o">&amp;&amp;</span> rm /var/www/pxe/clear-<span class="si">${</span><span class="nv">version</span><span class="si">}</span>-pxe.tar.xz
<span class="gp">#</span> <span class="nb">unset</span> version
</pre></div>
</div>
</div>
<div class="section" id="step-6">
<h3>Step 6</h3>
<p>Create an iPXE script named <code class="docutils literal"><span class="pre">ipxe_boot_script.txt</span></code> under the http server root
<code class="file docutils literal"><span class="pre">/var/www/pxe/</span></code>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &lt;&lt; EOF &gt; /var/www/pxe/ipxe_boot_script.txt
<span class="gp">#</span>!ipxe

<span class="go">kernel linux quiet rdinit=/usr/lib/systemd/systemd-bootchart initcall_debug tsc=reliable no_timer_check noreplace-smp rw initrd=initrd</span>
<span class="go">  initrd initrd</span>
<span class="go"> boot</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>If your kernel is not already named <code class="docutils literal"><span class="pre">linux</span></code>, either rename the kernel or create a symlink.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nv">kernel</span><span class="o">=</span><span class="k">$(</span>find /var/www/pxe/ -name <span class="s1">&#39;org.clearlinux.*&#39;</span><span class="k">)</span>
<span class="gp">#</span> ln -s <span class="si">${</span><span class="nv">kernel</span><span class="si">}</span> /var/www/pxe/linux
<span class="gp">#</span> <span class="nb">unset</span> kernel
</pre></div>
</div>
</div>
<div class="section" id="step-7">
<h3>Step 7</h3>
<p>Create a configuration file for the http service (nginx in this example) to
serve the kernel, initramfs, and ipxe_boot_script in
<code class="file docutils literal"><span class="pre">/etc/nginx/nginx.conf</span></code> with the following:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir /etc/nginx/
<span class="gp">#</span> cat &lt;&lt; EOF &gt; /etc/nginx/nginx.conf
<span class="go">server {</span>
<span class="go">    listen       80;</span>
<span class="go">    server_name  hostname;</span>
<span class="go">    server_name_in_redirect off;</span>
<span class="go">    location / {</span>
<span class="go">        root   /var/www/pxe;</span>
<span class="go">        autoindex on;</span>
<span class="go">        index  index.html index.htm;</span>
<span class="go">    }</span>
<span class="go">}</span>
<span class="go">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="step-8">
<h3>Step 8</h3>
<p>Start the nginx service:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl start nginx.service
</pre></div>
</div>
</div>
<div class="section" id="step-9">
<h3>Step 9</h3>
<p>To use PXE chainloading, set up ISC DHCPD to first assign <code class="docutils literal"><span class="pre">undionly.kpxe</span></code> to any
legacy PXE clients, and to then assign boot configuration to iPXE clients. Do this
by telling ISC DHCPD to make the assignments based on the DHCP user class. Here’s
one way to do this using the <code class="file docutils literal"><span class="pre">/etc/dhcpd.conf</span></code> file:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span>allow booting;
allow bootp;
DHCPDARGS=&quot;interface&quot;;

# Set up a class to assign an &quot;IP only&quot; to devices attempting network boot.
class &quot;pxeclients&quot; {
        match if substring(option vendor-class-identifier, 0, 9) = &quot;PXEClient&quot;;
        next-server 192.168.1.1;
        if exists user-class and option user-class = &quot;iPXE&quot; {
                filename &quot;http://my.web.server/ipxe_boot_script.txt&quot;;
        } elsif exists client-arch and option client-arch = 9 {
                # client-arch = 9 (64-bit EFI)
                filename &quot;ipxe.efi&quot;;
        } else {
                # client-arch = 0 (Standard PC BIOS)
                filename &quot;undionly.kpxe&quot;;
        }
}

# Private subnet, in case you aren&#39;t able to run your own network wide DHCP service.
# Works when the machine you are network booting has two network interfaces,
# one connected to the private PXE boot network and the other connected to an external
# network.
subnet 192.168.0.0 netmask 255.255.0.0 {
        pool {
                # These IPs will only be asigned to PXE clients
                allow members of &quot;pxeclients&quot;;
                range 192.168.1.150 192.168.1.254;
        }

        # If you are not doing the NAT setup do not add the following to this
        # section. These IPs will be assigned to the hosts when they boot and
        # after they have been installed
        range 192.168.1.2 192.168.1.149;
        default-lease-time 600;
        max-lease-time 7200;
        option subnet-mask 255.255.0.0;
        option broadcast-address 192.168.255.255;
        option routers 192.168.1.1;
        # If your external network runs its own DNS servers then replace the
        # following with those
        option domain-name-servers 8.8.8.8, 8.8.4.4;
        # You can leave this change this or remove it. It changes the FQDNs
        # of your hosts. So host bob can be accessed (from this machine) at
        # bob.example.com
        option domain-name &quot;example.com&quot;;
}
</pre></div>
</div>
<p>This ensures that either iPXE image (<code class="docutils literal"><span class="pre">undionly.kpxe</span></code> for BIOS or <code class="docutils literal"><span class="pre">ipxe.efi</span></code>
for EFI) is handed out only when the DHCP request comes from a legacy PXE client
or from a UEFI client, respectfully. Once iPXE loads, the DHCP server will direct it to
boot from options configured in your <code class="docutils literal"><span class="pre">http://my.web.server/real_boot_script.txt</span></code>
file.</p>
<p>Note.</p>
<p><code class="docutils literal"><span class="pre">192.168.1.1</span></code> is set to the address your TFTP server is using.</p>
<p><code class="docutils literal"><span class="pre">my.web.server</span></code> is set to the address your web server is using.</p>
<p><code class="docutils literal"><span class="pre">DHCPDARGS</span></code> is set to the interface you are using.</p>
<p>If you are doing a NAT setup then you need to set <code class="docutils literal"><span class="pre">interface</span></code> to the interface
connected to the internal network.</p>
</div>
<div class="section" id="step-10">
<h3>Step 10</h3>
<p>There are several DHCP options specific to <a class="reference external" href="http://ipxe.org/">iPXE</a> which are
not recognized by the standard ISC DHCPD installation. To add suport for these
options, add the following to the top of your <code class="file docutils literal"><span class="pre">/etc/dhcpd.conf</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span><span class="c1">##################################################</span>
<span class="gp">#</span>   iPXE-specific options                         <span class="c1">#</span>
<span class="gp">#</span>   Source: http://www.ipxe.org/howto/dhcpd       <span class="c1">#</span>
<span class="gp">#</span><span class="c1">##################################################</span>
<span class="go">option space ipxe;</span>
<span class="go">option client-arch code 93 = unsigned integer 16;</span>
<span class="go">option ipxe-encap-opts code 175 = encapsulate ipxe;</span>
<span class="go">option ipxe.priority code 1 = signed integer 8;</span>
<span class="go">option ipxe.keep-san code 8 = unsigned integer 8;</span>
<span class="go">option ipxe.skip-san-boot code 9 = unsigned integer 8;</span>
<span class="go">option ipxe.syslogs code 85 = string;</span>
<span class="go">option ipxe.cert code 91 = string;</span>
<span class="go">option ipxe.privkey code 92 = string;</span>
<span class="go">option ipxe.crosscert code 93 = string;</span>
<span class="go">option ipxe.no-pxedhcp code 176 = unsigned integer 8;</span>
<span class="go">option ipxe.bus-id code 177 = string;</span>
<span class="go">option ipxe.bios-drive code 189 = unsigned integer 8;</span>
<span class="go">option ipxe.username code 190 = string;</span>
<span class="go">option ipxe.password code 191 = string;</span>
<span class="go">option ipxe.reverse-username code 192 = string;</span>
<span class="go">option ipxe.reverse-password code 193 = string;</span>
<span class="go">option ipxe.version code 235 = string;</span>
<span class="go">option iscsi-initiator-iqn code 203 = string;</span>
<span class="gp">#</span> Feature indicators
<span class="go">option ipxe.pxeext code 16 = unsigned integer 8;</span>
<span class="go">option ipxe.iscsi code 17 = unsigned integer 8;</span>
<span class="go">option ipxe.aoe code 18 = unsigned integer 8;</span>
<span class="go">option ipxe.http code 19 = unsigned integer 8;</span>
<span class="go">option ipxe.https code 20 = unsigned integer 8;</span>
<span class="go">option ipxe.tftp code 21 = unsigned integer 8;</span>
<span class="go">option ipxe.ftp code 22 = unsigned integer 8;</span>
<span class="go">option ipxe.dns code 23 = unsigned integer 8;</span>
<span class="go">option ipxe.bzimage code 24 = unsigned integer 8;</span>
<span class="go">option ipxe.multiboot code 25 = unsigned integer 8;</span>
<span class="go">option ipxe.slam code 26 = unsigned integer 8;</span>
<span class="go">option ipxe.srp code 27 = unsigned integer 8;</span>
<span class="go">option ipxe.nbi code 32 = unsigned integer 8;</span>
<span class="go">option ipxe.pxe code 33 = unsigned integer 8;</span>
<span class="go">option ipxe.elf code 34 = unsigned integer 8;</span>
<span class="go">option ipxe.comboot code 35 = unsigned integer 8;</span>
<span class="go">option ipxe.efi code 36 = unsigned integer 8;</span>
<span class="go">option ipxe.fcoe code 37 = unsigned integer 8;</span>
<span class="go">option ipxe.vlan code 38 = unsigned integer 8;</span>
<span class="go">option ipxe.menu code 39 = unsigned integer 8;</span>
<span class="go">option ipxe.sdi code 40 = unsigned integer 8;</span>
<span class="go">option ipxe.nfs code 41 = unsigned integer 8;</span>
</pre></div>
</div>
</div>
<div class="section" id="step-11">
<h3>Step 11</h3>
<p>Create an empty <code class="file docutils literal"><span class="pre">/var/db/dhcpd.leases</span></code> file.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir /var/db/
<span class="gp">#</span> touch /var/db/dhcpd.leases
</pre></div>
</div>
</div>
<div class="section" id="step-12">
<h3>Step 12</h3>
<p>If you are doing the NAT setup skip this we will do it at the end.</p>
<p>Start the dhcp service:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl start dhcp4.service
</pre></div>
</div>
</div>
<div class="section" id="step-13">
<h3>Step 13</h3>
<p>From here on out we are doing NAT specific steps. Set your external and
internal network interface names to variables for convenience.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">export</span> <span class="nv">external_iface</span><span class="o">=</span>eno0
<span class="gp">#</span> <span class="nb">export</span> <span class="nv">internal_iface</span><span class="o">=</span>eno1
</pre></div>
</div>
<p>Disable auto-starting dhcp for all interfaces</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir -p /etc/systemd/network/
<span class="gp">#</span> <span class="nb">cd</span> /etc/systemd/network/
<span class="gp">#</span> ln -s /dev/null 80-dhcp.network
</pre></div>
</div>
<p>Set your external and internal network interfaces to behave accordingly. You
may need to change the external.network if the external network is not going to
assign this machine an IP via dhcp. The internal network address corresponds to
the settings in dhcpd.conf</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &lt;&lt; EOF &gt; 80-external-dynamic.network
<span class="go">[Match]</span>
<span class="go">Name=$external_iface</span>
<span class="go">[Network]</span>
<span class="go">DHCP=yes</span>
<span class="go">EOF</span>
<span class="gp">#</span> cat &lt;&lt; EOF &gt; 80-internal-static.network
<span class="go">[Match]</span>
<span class="go">Name=$internal_iface</span>
<span class="go">[Network]</span>
<span class="go">Address=192.168.1.1/16</span>
<span class="go">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="step-14">
<h3>Step 14</h3>
<p>Configure iptables to forward all traffic coming from inside the NAT to the
external network. Without this swupd will not be able to connect to the
internet.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &lt;&lt; EOF &gt; ~/natrules
<span class="go">*nat</span>
<span class="go">:PREROUTING ACCEPT [5077:516379]</span>
<span class="go">:INPUT ACCEPT [5054:514369]</span>
<span class="go">:OUTPUT ACCEPT [147:7526]</span>
<span class="go">:POSTROUTING ACCEPT [114:5508]</span>
<span class="go">:PROXY - [0:0]</span>
<span class="go">-A POSTROUTING -o $external_iface -j MASQUERADE</span>
<span class="go">COMMIT</span>
<span class="go">*filter</span>
<span class="go">:INPUT ACCEPT [338542:30287508]</span>
<span class="go">:FORWARD ACCEPT [168279:154877988]</span>
<span class="go">:OUTPUT ACCEPT [49875:536021461]</span>
<span class="go">-A FORWARD -i $external_iface -o $internal_iface -m state --state RELATED,ESTABLISHED -j ACCEPT</span>
<span class="go">-A FORWARD -i $internal_iface -o $external_iface -j ACCEPT</span>
<span class="go">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span>
<span class="go">COMMIT</span>
<span class="go">EOF</span>
<span class="gp">#</span> iptables-restore ~/natrules
<span class="gp">#</span> <span class="k">for</span> unitfile in <span class="k">$(</span><span class="nb">cd</span> /usr/lib/systemd/system/<span class="p">;</span> ls ip*<span class="k">)</span>
<span class="go">do</span>
<span class="go">systemctl enable ${unitfile}</span>
<span class="go">systemctl start ${unitfile}</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Tell the kernel to forward packets. Without this the above rules do nothing.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
<span class="gp">#</span> <span class="nb">echo</span> net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span> &gt; /etc/sysctl.conf
</pre></div>
</div>
</div>
<div class="section" id="step-15">
<h3>Step 15</h3>
<p>Restart all your networking. If you did something wrong then you may loose
connection if you are working over ssh.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl restart systemd-networkd
<span class="gp">#</span> systemctl restart dhcp4.service
</pre></div>
</div>
</div>
</div>
<div class="section" id="pxe-grub">
<h2>PXE + GRUB</h2>
<p>Another option for network booting Clear Linux* OS for Intel Architecture is to
use the GRUB bootloader to boot in UEFI mode. The bootloader will get its files
over TFTP; it does not require having another service to host the network boot
artifacts. The following sets up up a PXE using the GRUB bootloader environment
and Clear Linux OS for Intel Architecture, but the configuration options should
apply elsewhere.</p>
<p>First, add the <code class="docutils literal"><span class="pre">pxe-server</span></code> bundle to your system with:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> swupd bundle-add pxe-server
</pre></div>
</div>
<div class="section" id="dhcp-configuration">
<h3>DHCP configuration</h3>
<p>Add the following content to your <code class="file docutils literal"><span class="pre">/etc/dhcpd.conf</span></code> file:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">allow booting;</span>
<span class="go">allow bootp;</span>

<span class="gp">#</span> Set up a class so you can give out an IP only <span class="k">for</span> devices is attempting network boot.
<span class="go"> {</span>
<span class="go"> match if substring(option vendor-class-identifier, 0, ;</span>
<span class="go">        next-server 192.168.1.1;</span>
<span class="go"> grubx64.</span>
<span class="go">}</span>

<span class="gp">#</span> Private subnet, in <span class="k">case</span> you are able to run your own network wide DHCP service.
<span class="gp">#</span> Works when the machine you are network booting has two network interfaces,
<span class="gp">#</span> one connected to the private PXE boot network and the other connected to an external
<span class="gp">#</span> network.
<span class="go">subnet 192.168.1.0 netmask 255.255.255.0 {</span>
<span class="go">        pool {</span>
<span class="go">        allow members</span>
<span class="go">                range 192.168.1.100 192.168.1.200;</span>
<span class="go">        }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Where <code class="docutils literal"><span class="pre">192.168.1.1</span></code> is set to the address your TFTP server is using, and <code class="docutils literal"><span class="pre">grubx64.efi</span></code> is set
to the name of your grub bootloader file.</p>
<p>The subnet being used in this example is private; if the DHCPD service you use applies to your
entire network, modify the configuration as needed. Also, if multiple devices (including those
not using UEFI) are being supported by this DHCPD service, adding the following logic will allow
selection of the filename fetched from the client:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">if exists client-arch and option client-arch = 9 {</span>
<span class="gp">        #</span> client-arch <span class="o">=</span> <span class="m">9</span> <span class="o">(</span>64-bit EFI<span class="o">)</span>
<span class="go">        filename &quot;grubx64.efi&quot;;</span>
<span class="go">} elsif exists client-arch and option client-arch = 6 {</span>
<span class="gp">        #</span> client-arch <span class="o">=</span> <span class="m">6</span> <span class="o">(</span>32-bit EFI<span class="o">)</span>
<span class="go">        filename &quot;grubx32.efi&quot;;</span>
<span class="go">} else {</span>
<span class="gp">        #</span> client-arch <span class="o">=</span> <span class="m">0</span> <span class="o">(</span>Standard PC BIOS<span class="o">)</span>
<span class="go">        filename &quot;pxelinux.0&quot;;</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Next, create an empty <code class="file docutils literal"><span class="pre">/var/db/dhcp.leases</span></code> file and start the dhcpd service with:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir -p /var/db
<span class="gp">#</span> touch /var/db/dhcp.leases
<span class="gp">#</span> systemctl start dhcp4.service
</pre></div>
</div>
</div>
<div class="section" id="grub-configuration">
<h3>GRUB configuration</h3>
<p>Create the GRUB bootloader file (<code class="file docutils literal"><span class="pre">grubx64.efi</span></code>) with the following
command; it will create the file in your current directory.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> grub-mkimage -O x86_64-efi -o grubx64.efi all_video boot btrfs cat
<span class="go">chain configfile echo efifwsetup efinet ext2 fat font gfxmenu gfxterm</span>
<span class="go">gzio halt hfsplus iso9660 jpeg linuxefi loadenv loopback lvm mdraid09</span>
<span class="go">mdraid1x minicmd multiboot multiboot2 normal part_apple part_msdos</span>
<span class="go">part_gpt password_pbkdf2 png reboot search search_fs_uuid search_fs_file</span>
<span class="go">search_label serial sleep syslinuxcfg test tftp usbserial_pl2303</span>
<span class="go">usbserial_ftdi xfs</span>
</pre></div>
</div>
<p>Next, a GRUB configuration file (<code class="file docutils literal"><span class="pre">grub.cfg</span></code>) should contain the
following content:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">set pager=1</span>

<span class="go">export menuentry_id_option</span>

<span class="go">function load_video {</span>
<span class="go">  if [ x$feature_all_video_module = xy ]; then</span>
<span class="go">    insmod all_video</span>
<span class="go">  else</span>
<span class="go">    insmod efi_gop</span>
<span class="go">    insmod efi_uga</span>
<span class="go">    insmod ieee1275_fb</span>
<span class="go">    insmod vbe</span>
<span class="go">    insmod vga</span>
<span class="go">    insmod video_bochs</span>
<span class="go">    insmod video_cirrus</span>
<span class="go">  fi</span>
<span class="go">}</span>

<span class="go">terminal_output console</span>
<span class="go">if [ x$feature_timeout_style = xy ] ; then</span>
<span class="go">  set timeout_style=menu</span>
<span class="go">  set timeout=5</span>
<span class="go">else</span>
<span class="go">  set timeout=5</span>
<span class="go">fi</span>

<span class="go">menuentry &#39;Clear Linux Installation&#39; --class gnu-linux --class gnu --class os {</span>
<span class="go">  load_video</span>
<span class="go">  set gfxpayload=keep</span>
<span class="go">  insmod gzio</span>
<span class="go">  insmod part_gpt</span>
<span class="go">  insmod ext2</span>
<span class="go">  linuxefi /linux</span>
<span class="go">  initrdefi /initrd</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Where the Linux kernel is named <code class="docutils literal"><span class="pre">linux</span></code> and the initrd <code class="docutils literal"><span class="pre">initrd</span></code>.</p>
</div>
<div class="section" id="tftp-configuration">
<h3>TFTP configuration</h3>
<p>Clear Linux OS for Intel Archiecture uses <code class="docutils literal"><span class="pre">dnsmasq</span></code> to provide the tftpd
service. It requires the following entries exist in <code class="file docutils literal"><span class="pre">/etc/dnsmasq.conf</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">enable-tftp</span>
<span class="go">tftp-root=/srv/tftp/</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The Linux kernel and initrd files can be downloaded from</dt>
<dd><a class="reference external" href="https://download.clearlinux.org/current/">https://download.clearlinux.org/current/</a> (with a name like
<code class="docutils literal"><span class="pre">clear-$version-pxe.tar.xz</span></code>) as a compressed tar file containing two
clearly-labeled files that should be moved to the tftp root (<code class="docutils literal"><span class="pre">/srv/tftp/</span></code>,
per the tftp server configuration), as <code class="docutils literal"><span class="pre">linux</span></code> and <code class="docutils literal"><span class="pre">initrd</span></code> respectively.
The bootloader <code class="file docutils literal"><span class="pre">grubx64.efi</span></code> and its configuration file</dd>
</dl>
<p><code class="file docutils literal"><span class="pre">grub.cfg</span></code> should also be placed in the tftp root <code class="docutils literal"><span class="pre">/srv/tftp/</span></code>.</p>
<p>Now start the tftp service with this command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">systemctl start dnsmasq.service</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Network booting</a><ul>
<li><a class="reference internal" href="#network-setup-options">Network Setup Options</a></li>
<li><a class="reference internal" href="#network-topologies">Network Topologies</a><ul>
<li><a class="reference internal" href="#dual-nic">Dual NIC</a></li>
<li><a class="reference internal" href="#nat">NAT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pxe-ipxe">PXE + iPXE</a><ul>
<li><a class="reference internal" href="#step-1">Step 1</a></li>
<li><a class="reference internal" href="#step-2">Step 2</a></li>
<li><a class="reference internal" href="#step-3">Step 3</a></li>
<li><a class="reference internal" href="#step-4">Step 4</a></li>
<li><a class="reference internal" href="#step-5">Step 5</a></li>
<li><a class="reference internal" href="#step-6">Step 6</a></li>
<li><a class="reference internal" href="#step-7">Step 7</a></li>
<li><a class="reference internal" href="#step-8">Step 8</a></li>
<li><a class="reference internal" href="#step-9">Step 9</a></li>
<li><a class="reference internal" href="#step-10">Step 10</a></li>
<li><a class="reference internal" href="#step-11">Step 11</a></li>
<li><a class="reference internal" href="#step-12">Step 12</a></li>
<li><a class="reference internal" href="#step-13">Step 13</a></li>
<li><a class="reference internal" href="#step-14">Step 14</a></li>
<li><a class="reference internal" href="#step-15">Step 15</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pxe-grub">PXE + GRUB</a><ul>
<li><a class="reference internal" href="#dhcp-configuration">DHCP configuration</a></li>
<li><a class="reference internal" href="#grub-configuration">GRUB configuration</a></li>
<li><a class="reference internal" href="#tftp-configuration">TFTP configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="index_advanced_configuration.html">Advanced configuration</a><ul>
      <li>Previous: <a href="clear-containers.html" title="previous chapter">Intel® Clear Containers</a></li>
      <li>Next: <a href="bulk_provisioning.html" title="next chapter">Bulk Provisioning</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/network_boot.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, many.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/network_boot.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>